<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.codyy.oc.admin.dao.CostDaoMapper" >

	<select id="getCostSubTypeList" parameterType="int" resultType="com.codyy.oc.admin.entity.CostSubTypeBean">
		
		SELECT cost_subtype_id AS costSubTypeId,cost_type AS costType,name as name
		FROM COST_SUBTYPE
		WHERE 1=1
		<if test="_parameter == 0 || _parameter ==1">
			AND cost_type = #{_parameter}
		</if>
	
	</select>
	
	<insert id="insertCostEntity" parameterType="com.codyy.oc.admin.entity.CostEntityBean" >
		INSERT INTO COST_DETAIL
			(
				cost_id,
				create_time,
				cost_time,
				create_user_id,
				cost_type,
				cost_subtype_id,
				cost_num,
				dep_id,
				remark,
				status,
				cost_no
			)
		VALUES
			(
				#{costId},
				#{createTime},
				#{costTime},
				#{createUserId},
				#{costType},
				#{costSubtypeId},
				#{costNum},
				#{depId},
				#{remark},
				#{status},
				#{costNo}
			)
	</insert>
	
	<insert id="insertCostDepEntity" parameterType="com.codyy.oc.admin.entity.CostDepEntityBean" >
		INSERT INTO COST_DEP_DETAIL
			(
				cost_id,
				cost_dep,
				cost_year,
				cost_month,
				cost_date,
				cost_num
			)
		VALUES
			(
				#{costId},
				#{costDep},
				#{costYear},
				#{costMonth},
				#{costDate},
				#{costNum}
			)
	</insert>
	
	
	<!-- 更新成本表 -->
	<update id="updateCostDepEntity" parameterType="com.codyy.oc.admin.entity.CostDepEntityBean">
		UPDATE COST_DEP_DETAIL
		SET
			cost_year = #{costYear},
			cost_month = #{costMonth},
			cost_date = #{costDate},
			cost_num = #{costNum}
		WHERE cost_id = #{costId}
		AND cost_dep = #{costDep}
	</update>
	
		<!-- 更新成本表 -->
	<update id="updateCostEntity" parameterType="com.codyy.oc.admin.entity.CostEntityBean">
		UPDATE COST_DETAIL
		SET
			cost_time = #{costTime},
			cost_type = #{costType},
			cost_num = #{costNum},
			remark = #{remark},
			status = #{status}
		WHERE cost_id = #{costId}
	</update>
	
	<!-- 更新成本状态 -->
	<update id="updateCostStatus" parameterType="com.codyy.oc.admin.entity.CostEntityBean">
		UPDATE COST_DETAIL SET status = #{status}
		<if test="auditUser != null and auditUser != ''">
			,audit_user = #{auditUser}
		</if>
		WHERE cost_id = #{costId}
	</update>
	
	<!-- 取番 -->
	<select id="getCostNoSeq" parameterType="java.lang.String" resultType="com.codyy.oc.admin.entity.CostSeqBean" >
		SELECT
			type,date,seq
		FROM COST_SEQ
	 	WHERE Type = #{_parameter}
	</select>

	<update id="updateCostNoSeq" parameterType="com.codyy.oc.admin.entity.CostSeqBean">
		UPDATE
			COST_SEQ
		SET 
			date = #{date},
			seq = #{seq}
		WHERE type = #{type}
	</update>
	
	<update id="insertCostNoSeq" parameterType="com.codyy.oc.admin.entity.CostSeqBean">
		INSERT INTO COST_SEQ
			(
				type,
				date,
				seq
			)
		VALUES
			(
				#{type},
				#{date},
				#{seq}
			)
	</update>
	
	
	<select id="getCostEntityById" parameterType="java.lang.String" resultType="com.codyy.oc.admin.entity.CostEntityBean">
		SELECT
			cost_id AS costId,
			create_time AS createTime,
			cost_time AS costTime,
			create_user_id AS createUserId,
			cost_type AS costType, 
			cost_subtype_id AS costSubtypeId,
			cost_num AS costNum,
			dep_id AS depId,
			remark AS remark
		FROM COST_DETAIL
	 	WHERE cost_id = #{_parameter}
	</select>
	
	<!-- 根据costID取成本部门划分信息 -->
	<select id="getCostDepList" parameterType="java.lang.String" resultType="com.codyy.oc.admin.entity.CostDepEntityBean">
		SELECT
			a.cost_id AS costId,
			a.cost_dep AS costDep,
			b.name AS costDepName,
			a.cost_year AS costYear,
			a.cost_month AS costMonth,
			a.cost_date AS costDate, 
			a.cost_num AS costNum
		FROM COST_DEP_DETAIL a
		LEFT JOIN DEPARTMENT b on a.cost_dep = b.dep_id
	 	WHERE cost_id = #{_parameter}
	</select>
	
	<delete id="delCostEntityById" parameterType="java.lang.String">
	
		DELETE FROM COST_DETAIL WHERE cost_id = #{_parameter}
		
	</delete>
	
	<!-- 申请列表 -->
	<select id="getCostPageList" parameterType="com.codyy.commons.page.Page" resultType="com.codyy.oc.admin.vo.CostVO">
		SELECT
			dep.`name` AS depName,
			costSub.`name` AS costSubName,
			costDetail.cost_id AS costId,
			costDetail.cost_num AS costNum,
			costDetail.cost_time AS costTime,
			costDetail.cost_type AS costType,
			costDetail.create_time AS createTime,
			costDetail.remark as remark,
			costDetail.cost_no as costNo,
			costDetail.status,
			code.content as statusName,
			'view' as editMode
		FROM
			COST_DETAIL costDetail
		LEFT JOIN COST_SUBTYPE costSub ON costDetail.cost_subtype_id = costSub.cost_subtype_id
		LEFT JOIN DEPARTMENT dep ON costDetail.dep_id = dep.dep_id
		LEFT JOIN CODE_CONTENT code on costDetail.status = code.id and codeName = 'CodeStatus'
		where 1=1 
			
			<if test="map.costType != null and  map.costType != ''">
				AND costDetail.cost_type = #{map.costType}
			</if>
			
			<if test="map.userId != null and  map.userId != ''">
				AND costDetail.create_user_id = #{map.userId}
			</if>
			
			<if test="map.startTime != null and map.startTime !=''">
				AND costDetail.cost_time <![CDATA[ >= ]]> #{map.startTime}
			</if>
			
			<if test="map.endTime != null and map.endTime != ''">
				AND costDetail.cost_time <![CDATA[ <= ]]> #{map.endTime}
			</if>
		
		ORDER BY costDetail.create_time DESC
	
	</select>
	
	<!-- 审批列表 -->
	<select id="getCostAuditPageList" parameterType="com.codyy.commons.page.Page" resultType="com.codyy.oc.admin.vo.CostVO">
		SELECT
			dep.`name` AS depName,
			costSub.`name` AS costSubName,
			costDetail.cost_id AS costId,
			costDetail.cost_num AS costNum,
			costDetail.cost_time AS costTime,
			costDetail.cost_type AS costType,
			costDetail.create_time AS createTime,
			costDetail.remark as remark,
			costDetail.cost_no as costNo,
			costDetail.status,
			costDetail.audit_user as auditUser,
			audit.realname AS auditUserName,
			costDetail.create_user_id AS subUser,
			subUser.realname as subUserName,
			code.content as statusName,
			'view' as editMode
		FROM
			COST_DETAIL costDetail
		LEFT JOIN COST_SUBTYPE costSub ON costDetail.cost_subtype_id = costSub.cost_subtype_id
		LEFT JOIN DEPARTMENT dep ON costDetail.dep_id = dep.dep_id
		LEFT JOIN CODE_CONTENT code on costDetail.status = code.id and codeName = 'CodeStatus'
		LEFT JOIN ADMIN_USER audit on costDetail.audit_user = audit.user_id
		LEFT JOIN ADMIN_USER subUser on costDetail.create_user_id = subUser.user_id
		where 1=1 
			
			<if test="map.costType != null and  map.costType != ''">
				AND costDetail.cost_type = #{map.costType}
			</if>
			
			<!-- 管理员时 条件设定为部门领导审核通过的 -->
			<if test="map.userId == 'admin'">
				AND (costDetail.status in ('03','04','05'))
			</if>
			
			<if test="map.userId != 'admin'">
				AND costDetail.dep_id = #{map.depId}
				AND (costDetail.status in ('01','02','03','04','05'))
			</if>
			
			<if test="map.startTime != null and map.startTime !=''">
				AND costDetail.cost_time <![CDATA[ >= ]]> #{map.startTime}
			</if>
			
			<if test="map.endTime != null and map.endTime != ''">
				AND costDetail.cost_time <![CDATA[ <= ]]> #{map.endTime}
			</if>
		
		ORDER BY costDetail.create_time DESC
	
	</select>
	
	
	<select id="getCostOutlayType" parameterType="com.codyy.oc.admin.vo.CostVO" resultType="com.codyy.oc.admin.vo.CostMonthInOut">
		SELECT costSubtype.name,DATE_FORMAT(costDetail.cost_time,'%m') month,sum(costDetail.cost_num) AS total
		FROM COST_DETAIL costDetail,COST_SUBTYPE costSubtype  
		WHERE costDetail.cost_type = #{costType} 
			  AND costDetail.cost_subtype_id = costSubtype.cost_subtype_id
			
			<if test="depId !=null ">
				
				AND costDetail.dep_id = #{depId}
				
			</if>
			
			AND costDetail.cost_time <![CDATA[ >= ]]> #{startTime}
			
			AND costDetail.cost_time <![CDATA[ <= ]]> #{endTime}
			
			group by month,costDetail.cost_subtype_id 
			order by month,costDetail.cost_subtype_id
	
	</select>
	
	<select id="getCostDepartIncomeType" parameterType="com.codyy.oc.admin.vo.CostVO" resultType="com.codyy.oc.admin.vo.CostMonthInOut">
		SELECT depart.name,DATE_FORMAT(costDetail.cost_time,'%m') month,sum(costDetail.cost_num) AS total 
		FROM COST_DETAIL costDetail, DEPARTMENT as depart
		WHERE costDetail.cost_type = #{costType}
		
			AND costDetail.dep_id = depart.dep_id
		
			<if test="depId !=null ">
				AND costDetail.dep_id = #{depId}
			</if>
			
			AND costDetail.cost_time <![CDATA[ >= ]]> #{startTime}
			
			AND costDetail.cost_time <![CDATA[ <= ]]> #{endTime}
			
			group by month,costDetail.dep_id 
			order by depart.name
	
	</select>
	
	<select id="getCostInOutType" parameterType="com.codyy.oc.admin.vo.CostVO" resultType="com.codyy.oc.admin.vo.CostMonthInOut">
		SELECT sum(costDetail.cost_num) AS total 
		FROM COST_DETAIL costDetail
		WHERE costDetail.cost_type = #{costType}
		
			<if test="depId !=null ">
				AND costDetail.dep_id = #{depId}
			</if>
			
			AND costDetail.cost_time <![CDATA[ >= ]]> #{startTime}
			
			AND costDetail.cost_time <![CDATA[ <= ]]> #{endTime}
			
	</select>
	
	<select id="getCostDepartInOutcome" parameterType="com.codyy.oc.admin.vo.CostVO" resultType="com.codyy.oc.admin.vo.CostMonthInOut">
		SELECT depart.name,DATE_FORMAT(costDetail.cost_time,'%m') 'month',costDetail.cost_type AS `type`,SUM(costDetail.cost_num) AS total 
		FROM COST_DETAIL costDetail, DEPARTMENT AS depart
		WHERE costDetail.dep_id = depart.dep_id
			<if test="depId !=null ">
				AND costDetail.dep_id = #{depId}
			</if>		
			AND costDetail.cost_time <![CDATA[ >= ]]> #{startTime}
			AND costDetail.cost_time <![CDATA[ <= ]]> #{endTime}
			
			GROUP BY costDetail.cost_type,MONTH,costDetail.dep_id 
			ORDER BY depart.name,MONTH,costDetail.cost_type
	
	</select>
	
	<select id="getCostVOList" parameterType="com.codyy.oc.admin.vo.CostVO" resultType="com.codyy.oc.admin.vo.CostVO">
		SELECT dep.`name` AS depName,
				costSub.`name` AS costSubName,
				costDetail.cost_id AS costId,
				costDetail.cost_num AS costNum,
				costDetail.cost_time AS costTime,
				costDetail.cost_type AS costType,
				costDetail.create_time AS createTime
				
		FROM COST_DETAIL costDetail,COST_SUBTYPE costSub,DEPARTMENT dep
		WHERE costDetail.cost_subtype_id = costSub.cost_subtype_id
			  AND costDetail.dep_id = dep.dep_id
			  
			  <if test="depId !=null and depId!=''">
				AND costDetail.dep_id = #{depId}
			  </if>
			  
			AND costDetail.cost_type = #{costType}
			
			AND costDetail.cost_time <![CDATA[ >= ]]> #{startTime}
			
			AND costDetail.cost_time <![CDATA[ <= ]]> #{endTime}
			  
	</select>
	
</mapper>